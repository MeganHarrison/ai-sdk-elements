name: Update Supabase Types (Direct Commit)

on:
  # Manual trigger
  workflow_dispatch:
  
  # After database migrations are applied
  workflow_run:
    workflows: ["Deploy Database Migrations"]
    types:
      - completed
  
  # On repository dispatch (can be triggered by webhooks)
  repository_dispatch:
    types: [update-database-types]

jobs:
  update-types-direct:
    runs-on: ubuntu-latest
    
    # Only run if the triggering workflow was successful
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Generate TypeScript types
        run: |
          echo "ðŸ”„ Generating Supabase types..."
          npx supabase gen types typescript \
            --project-id lgveqfnpkxvzbnnwuled \
            --schema public \
            > database.types.ts
          
          echo "âœ… Types generated successfully"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Check for changes
        id: verify
        run: |
          if git diff --quiet database.types.ts; then
            echo "â„¹ï¸ No changes detected in database types"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "âœ¨ Database types have been updated"
            echo "changed=true" >> $GITHUB_OUTPUT
            git diff --stat database.types.ts
          fi
      
      - name: Commit and push changes
        if: steps.verify.outputs.changed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add database.types.ts
          git commit -m "chore: update Supabase database types [skip ci]
          
          Auto-generated by GitHub Actions
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_number }}"
          
          git push origin main
      
      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ“Š Supabase Types Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify.outputs.changed }}" == "true" ]; then
            echo "âœ… **Status:** Types updated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changes" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            git diff HEAD~1 database.types.ts | head -50 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Status:** No changes detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Database types are already up to date." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Project ID: \`lgveqfnpkxvzbnnwuled\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY